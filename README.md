#### PostgreSQL & RUST : Using Diesel Crate

References

- https://diesel.rs/guides/getting-started
- https://doc.rust-lang.org/cargo/reference/manifest.html

#### Steps

Create ENV File, Which has postgres connection URL

```bash
echo DATABASE_URL=postgres://username:password@localhost/testdb > .env
```

```bash
cargo install diesel_cli
cargo install diesel_cli --no-default-features --features postgres
```

Generate `diesel.toml`

The below command : This will create our database (if it didn’t already exist),<br/>
and create an empty migrations directory that we can use to manage our schema (more on that later).

```bash
diesel setup
```

Migrations allow us to evolve the database schema over time. <br/>
Each migration can be applied (up.sql) or reverted (down.sql). <br/>
Applying and immediately reverting a migration should leave your database schema unchanged.

```bash
diesel migration generate create_posts
```

The above command will generate

- `migrations/2023-03-10-184409_create_posts/up.sql`
- `migrations/2023-03-10-184409_create_posts/down.sql`

Populate `migrations/20160815133237_create_posts/up.sql` with following contents

```sql
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title VARCHAR NOT NULL,
    body TEXT NOT NULL,
    published BOOLEAN NOT NULL DEFAULT FALSE
);
```

Populate `migrations/2023-03-10-184409_create_posts/down.sql` with following contents

```sql
DROP TABLE posts;
```

We can apply our new migration

```bash
diesel migration run
```

Connect to postgresql and verify

```sql
testdb=> \d posts

            Table "public.posts"
            
  Column   |       Type        | Collation | Nullable |              Default
-----------+-------------------+-----------+----------+-----------------------------------
 id        | integer           |           | not null | nextval('posts_id_seq'::regclass)
 title     | character varying |           | not null |
 body      | text              |           | not null |
 published | boolean           |           | not null | false
Indexes:
    "posts_pkey" PRIMARY KEY, btree (id)
```

To Redo the migration (Warning : this will drop the table)

```bash
diesel migration redo
```

#### Notes

`#[derive(Queryable)]` ---> will generate all of the code needed to load a Post struct from a SQL query.


Typically the schema module isn’t created by hand, it gets generated by Diesel. When we ran diesel setup, a file 
called diesel.toml was created which tells Diesel to maintain a file at `src/schema.rs` for us.
The file should look like this:

```rust
// @generated automatically by Diesel CLI.

diesel::table! {
    books (id) {
        id -> Int4,
        title -> Varchar,
        author -> Varchar,
        published -> Bool,
    }
}

diesel::table! {
    posts (id) {
        id -> Int4,
        title -> Varchar,
        body -> Text,
        published -> Bool,
    }
}

diesel::table! {
    users (user_id) {
        user_id -> Text,
        first_name -> Nullable<Text>,
        last_name -> Nullable<Text>,
        email -> Nullable<Text>,
        phone -> Nullable<Text>,
        active -> Nullable<Bool>,
        balance -> Nullable<Text>,
        string_rep -> Nullable<Text>,
    }
}

diesel::allow_tables_to_appear_in_same_query!(
    books,
    posts,
    users,
);
```

Using `#[derive(Queryable)]` assumes that the order of fields on the Post struct matches the columns in the 
posts table, so make sure to define them in the order seen in the `schema.rs` file.

When we call .get_result on an insert or update statement, it automatically adds RETURNING * to the end of the 
query, and lets us load it into any struct that implements Queryable for the right types. Neat!

Diesel can insert more than one record in a single query. Just pass a Vec or slice to insert, and 
then call get_results instead of get_result. If you don’t actually want to do anything with the row 
that was just inserted, call .execute instead. The compiler won’t complain at you, that way

#### Running the code

We can run our new script with `cargo run --bin write_post`

- `cargo run --bin show_posts`
- `cargo run --bin publish_post 1`
- `cargo run --bin delete_post demo`